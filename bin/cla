#!/bin/sh
#
# An extendable tool suite for data analysis from the command line.

## environment variables and arguments
if [ -z $CLA_TDIR ];then CLA_TDIR="/tmp/cla"; fi
if [ -z $CLA_MODS ];then CLA_MODS=""; fi
if [ -z $CLA_INCR ];then CLA_INCR=0; fi

options(){
    echo -e ""
    echo -e "The following options may be specified."
    echo -e "\t-h\tprint usage information"
    echo -e "\t-i\ttoggle incremental results"
    echo -e "\t-t TDIR\tspecify TDIR as the cla tmp directory"
    echo -e "\t-d MDIR\tspecify MDIR as the cla module directory"
    echo -e "\t-m MODS\tspecify a comma seperated list of the modules to be used"
    echo -e ""
    exit 0
}

while getopts :hit:d:m: option;do
    case "$option" in
        h) echo -e "Reads data from STDIN and writes analysis to STDOUT." && options ;;
        i) 
            if [ $CLA_INCR -eq 0 ];then
                CLA_INCR=1
            else
                CLA_INCR=0
            fi ;;
        t) CLA_TDIR="$OPTARG" ;;
        d) CLA_MDIR="$OPTARG" ;;
        m) CLA_MODS="$OPTARG" ;;
        *) echo "invalid argument!" && options ;;
    esac
done

if [ "$CLA_MDIR" = "" ];then
    echo "The CLA_MDIR environment variable must point to your cla/modules directory."
    exit 1
fi

if [ "$CLA_MODS" = "" ];then
    for module in $CLA_MDIR/*;do
        if [ "$CLA_MODS" = "" ];then
            CLA_MODS="$(basename $module)"
        else
            CLA_MODS="$(basename $module),$CLA_MODS"
        fi
    done
fi

## setup
mkdir -p $CLA_TDIR
IFS=","
for module in $CLA_MODS;do
    pipe="$CLA_TDIR/$module"
    rm -f $pipe.in $pipe.out
    mkfifo $pipe.in $pipe.out
    $CLA_MDIR/$module < $pipe.in > $pipe.out &
done

## processing
IFS="
"
for line in $(cat -);do
    IFS=","
    for module in $CLA_MODS;do
        echo "$line" >> "$CLA_TDIR/$module.in";
        if [ $CLA_INCR -eq 1 ];then
            echo -ne "$module:$(head -1 $CLA_TDIR/$module.out) "
        fi
    done
    if [ $CLA_INCR -eq 1 ];then echo ""; fi
done

## cleanup
for module in $CLA_MODS;do
    if [ $CLA_INCR -eq 0 ];then
        echo -e "$module\t$(tail -1 $CLA_TDIR/$module.out)"
    fi
done
rm -rf $CLA_TDIR
